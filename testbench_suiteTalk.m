function out = testbench_suiteTalk
% TESTBENCH_SUITETALK Exercise audio plugin class
% to check for violations of plugin constraints and other errors.
%
% OUT = TESTBENCH_SUITETALK Return the output data from the
% plugin. This is useful to verify that plugin numeric behavior has not
% changed, when you are changing your plugin in ways that should not
% affect that behavior (eg, refactoring code).
%
% You can test whether your MATLAB plugin code is ready for code
% generation by creating and running a mex function from this testbench:
%
%   codegen testbench_suiteTalk    % Create the mex function
%   testbench_suiteTalk_mex        % Run the mex function
%
% You can use this testbench as a template and edit it to meet your
% testing needs. Rename the file to ensure your work is not
% accidentally overwritten and lost by another run of
% validateAudioPlugin.
%
% Automatically generated by validateAudioPlugin 08-Jun-2025 11:10:35 UTC-04:00

% Set basic test parameters
sampleRates = [44100, 48000, 96000, 192000, 32000];
frameSizes = [ 2.^(1:13) 2.^(2:13)-1 2.^(1:13)+1];
totalFrameSize = sum(frameSizes);

% Create output buffer if requested
if nargout > 0
    nout = 2;
    obuf = zeros(totalFrameSize*numel(sampleRates), nout);
    optr = 1;
end

% Instantiate the plugin
plugin = suiteTalk;
setup(plugin, zeros(2, 2));

% Test at each sample rate
for sampleRate = sampleRates
    paramState = initParamState(plugin);

    % Tell plugin the current sample rate
    setSampleRate(plugin, sampleRate);
    reset(plugin);
    checkForTampering(plugin, paramState, sampleRate, 'Resetting plugin');

    % Create input data: logarithmically swept sine waves, with a
    % different initial phase for each channel
    phaseOffsets = (0:1)/1 * 0.5 * pi;
    ibuf = logchirp(20, 20e3, sampleRate, totalFrameSize, phaseOffsets);
    iptr = 1;

    % Process data using different frame sizes
    for i = 1:numel(frameSizes)
        samplesPerFrame = frameSizes(i);

        val = fromNormalizedAttackTime(mod(floor((i-1)./1),3)/2);
        plugin.AttackTime = val;
        paramState.AttackTime = val;
        checkForTampering(plugin, paramState, sampleRate, ...
            'Setting parameter ''AttackTime''');

        val = fromNormalizedReleaseTime(mod(floor((i-1)./3),3)/2);
        plugin.ReleaseTime = val;
        paramState.ReleaseTime = val;
        checkForTampering(plugin, paramState, sampleRate, ...
            'Setting parameter ''ReleaseTime''');

        val = fromNormalizedClosedGain_dB(mod(floor((i-1)./9),3)/2);
        plugin.ClosedGain_dB = val;
        paramState.ClosedGain_dB = val;
        checkForTampering(plugin, paramState, sampleRate, ...
            'Setting parameter ''ClosedGain_dB''');

        val = fromNormalizedcombAmount(mod(floor((i-1)./27),3)/2);
        plugin.combAmount = val;
        paramState.combAmount = val;
        checkForTampering(plugin, paramState, sampleRate, ...
            'Setting parameter ''combAmount''');

        val = fromNormalizedRatio(mod(floor((i-1)./81),3)/2);
        plugin.Ratio = val;
        paramState.Ratio = val;
        checkForTampering(plugin, paramState, sampleRate, ...
            'Setting parameter ''Ratio''');

        % Get a frame of input data
        in = ibuf(iptr:iptr+samplesPerFrame-1, :);
        iptr = iptr + samplesPerFrame;

        % Run the plugin
        o1 = step(plugin, in(1:samplesPerFrame,1:2));

        % Save the output data if requested
        if nargout > 0
            obuf(optr:optr+samplesPerFrame-1, :) = o1;
            optr = optr + samplesPerFrame;
        end

        % Verify class and size of outputs
        if ~isa(o1, 'double')
            error('ValidateAudioPlugin:OutputNotDouble', ...
                ['Output 1 is of class %s, ' ...
                'but should have been double.'], ...
                class(o1));
        end
        if size(o1,1) ~= samplesPerFrame
            error('ValidateAudioPlugin:BadOutputFrameSize', ...
                ['Output 1 produced a frame size of %d, ' ...
                'but should have matched the input frame size of %d.'], ...
                size(o1,1), samplesPerFrame);
        end
        if size(o1,2) ~= 2
            error('ValidateAudioPlugin:BadOutputWidth', ...
                ['Width of output 1 was %d, ' ...
                'but should have been 2 (OutputChannels(1)).'], ...
                size(o1,2));
        end
        checkForTampering(plugin, paramState, sampleRate, 'Running plugin');
    end
end

% Return output data if requested
if nargout > 0
    out = obuf;
end
end

function checkForTampering(plugin, paramState, sampleRate, cause)
% Verify parameters were not tampered with
if ~isequal(paramState.AttackTime, plugin.AttackTime)
    error('ValidateAudioPlugin:ParamChanged', ...
        '%s changed parameter ''AttackTime'' from %g to %g.', ...
        cause, paramState.AttackTime, plugin.AttackTime);
end
if ~isequal(paramState.ReleaseTime, plugin.ReleaseTime)
    error('ValidateAudioPlugin:ParamChanged', ...
        '%s changed parameter ''ReleaseTime'' from %g to %g.', ...
        cause, paramState.ReleaseTime, plugin.ReleaseTime);
end
if ~isequal(paramState.ClosedGain_dB, plugin.ClosedGain_dB)
    error('ValidateAudioPlugin:ParamChanged', ...
        '%s changed parameter ''ClosedGain_dB'' from %g to %g.', ...
        cause, paramState.ClosedGain_dB, plugin.ClosedGain_dB);
end
if ~isequal(paramState.combAmount, plugin.combAmount)
    error('ValidateAudioPlugin:ParamChanged', ...
        '%s changed parameter ''combAmount'' from %g to %g.', ...
        cause, paramState.combAmount, plugin.combAmount);
end
if ~isequal(paramState.Ratio, plugin.Ratio)
    error('ValidateAudioPlugin:ParamChanged', ...
        '%s changed parameter ''Ratio'' from %g to %g.', ...
        cause, paramState.Ratio, plugin.Ratio);
end
% Verify sample rate was not tampered with
if ~isequal(getSampleRate(plugin), sampleRate)
    error('ValidateAudioPlugin:SampleRateChanged', ...
        '%s changed sample rate from %g to %g.', ...
        cause, sampleRate, getSampleRate(plugin));
end
end

function y = logchirp(f0, f1, Fs, nsamples, initialPhase)
% logarithmically swept sine from f0 to f1 over nsamples, at Fs
y = zeros(nsamples,numel(initialPhase));
instPhi = logInstantaneousPhase(f0, f1, Fs, nsamples);
for i = 1:numel(initialPhase)
    y(:,i) = sin(instPhi + initialPhase(i));
end
end

function phi = logInstantaneousPhase(f0, f1, Fs, n)
final = n-1;
t = (0:final)/final;
t1 = final/Fs;
phi = 2*pi * t1/log(f1/f0) * (f0 * (f1/f0).^(t') - f0);
end

function paramState = initParamState(plugin)
paramState.AttackTime = plugin.AttackTime;
paramState.ReleaseTime = plugin.ReleaseTime;
paramState.ClosedGain_dB = plugin.ClosedGain_dB;
paramState.combAmount = plugin.combAmount;
paramState.Ratio = plugin.Ratio;
end

function val = fromNormalizedAttackTime(normval)
val = 0.001 * (1/0.001).^normval;
end

function val = fromNormalizedReleaseTime(normval)
val = 0.001 * (1/0.001).^normval;
end

function val = fromNormalizedClosedGain_dB(normval)
val = -120 + (-20--120)*normval;
end

function val = fromNormalizedcombAmount(normval)
val = -24 + (-6--24)*normval;
end

function val = fromNormalizedRatio(normval)
val = 1 + (10-1)*normval;
end
